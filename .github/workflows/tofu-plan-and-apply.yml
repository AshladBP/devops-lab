name: OpenTofu Plan & Apply

on:
  pull_request:
    branches: ["master"]
  push:
    branches: ["master"]

jobs:
  detect_changes:
    name: Detect Changed Folders
    runs-on: ubuntu-latest
    outputs:
      folders: ${{ steps.set-folders.outputs.folders }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Detect changed files
        id: detect
        uses: tj-actions/changed-files@v34
        with:
          fetch-depth: 2

      - name: Extract changed OpenTofu folders
        id: set-folders
        run: |
          declare -A FOLDER
          for file in ${{ steps.detect.outputs.all_changed_files }}; do
            DIR=$(dirname "$file")
            FOUND=false
            while [ "$DIR" != "." ] && [ "$DIR" != "/" ]; do
              if ls "$DIR"/*.tf 1> /dev/null 2>&1; then
                FOLDER["$DIR"]=1
                FOUND=true
                break
              fi
              DIR=$(dirname "$DIR")
            done
          done

          FOLDERS_JSON="[\"$(echo "${!FOLDER[@]}" | tr ' ' '","')\"]"
          echo "folders=$FOLDERS_JSON" >> $GITHUB_OUTPUT
          echo "Detected folders: $FOLDERS_JSON"

  run_tofu:
    name: Run Tofu Plan & Apply
    needs: detect_changes
    runs-on: ubuntu-latest
    permissions:
      id-token: write  
      contents: read
      pull-requests: write 
    if: ${{ needs.detect_changes.outputs.folders != '[]' }} 
    strategy:
      matrix:
        folder: ${{ fromJson(needs.detect_changes.outputs.folders) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Configure AWS credentials for Plan
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.PLAN_ROLE_ARN }}
          role-session-name: plan-${{ github.run_number }}-${{ github.actor }}
          aws-region: us-east-2

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1

      - name: Tofu Plan
        working-directory: ${{ matrix.folder }}
        run: |
          echo "Running plan in ${{ matrix.folder }}"
          tofu init -no-color -input=false
          tofu plan -no-color -input=false -lock=false

      - name: Configure AWS credentials for Apply
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.APPLY_ROLE_ARN }}
          role-session-name: apply-${{ github.run_number }}-${{ github.actor }}
          aws-region: us-east-2

      - name: Tofu Apply
        working-directory: ${{ matrix.folder }}
        run: |
          echo "Running apply in ${{ matrix.folder }}"
          tofu init -no-color -input=false
          tofu apply -no-color -input=false -lock-timeout=60m -auto-approve
